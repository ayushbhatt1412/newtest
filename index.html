<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King of Diamonds - Real Multiplayer Game</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .gradient-bg {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%); /* Darker gradient */
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.4); /* Stronger shadow for dark theme */
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .number-input {
            background: linear-gradient(45deg, #2d3748, #4a5568); /* Darker input */
            border: 2px solid #4a5568;
            transition: all 0.3s ease;
            color: #e2e8f0;
        }
        .number-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .player-card {
            background: linear-gradient(135deg, #2d3748, #4a5568); /* Darker player card */
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
            color: #e2e8f0;
        }
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            animation: confetti-fall 3s linear infinite;
            pointer-events: none;
            z-index: 9999;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .elimination-effect {
            opacity: 0.3;
            transition: opacity 1s ease-in-out;
        }
        .elimination-animation {
            animation: elimination 1s ease-in-out forwards;
        }
        @keyframes elimination {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 0.3; transform: scale(0.9); }
        }

        /* Dashboard specific styles */
        .dashboard-sidebar {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
            background: rgba(45, 55, 72, 0.8); /* Darker, slightly transparent */
            backdrop-filter: blur(8px); /* Stronger blur */
            border-right: 1px solid rgba(74, 85, 104, 0.5);
            padding: 1rem;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            overflow-y: auto;
            color: #e2e8f0;
        }
        .dashboard-player-card {
            background: rgba(74, 85, 104, 0.9); /* Darker player card in dashboard */
            border: 1px solid #4a5568;
            color: #e2e8f0;
        }
        .dashboard-player-card.eliminated {
            opacity: 0.5;
            text-decoration: line-through;
        }
        .winner-display-global {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 32, 44, 0.95); /* Darker overlay */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            animation: bounceIn 0.8s forwards;
            display: none;
            color: #e2e8f0;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4f46e5;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex">
    <div id="leftDashboard" class="dashboard-sidebar text-white flex flex-col hidden">
        <h3 class="text-xl font-bold mb-4 text-center text-gray-100">Participants</h3>
        <div id="dashboardPlayersList" class="space-y-3 flex-grow">
            </div>
        <div class="mt-auto pt-4 border-t border-gray-600 text-sm text-gray-300 text-center">
            Your ID: <span id="myPlayerIdDisplay" class="font-mono text-xs"></span>
        </div>
    </div>

    <div id="app" class="container mx-auto px-4 py-8 flex-grow">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl font-bold text-white mb-2">
                <i class="fas fa-crown text-yellow-400"></i>
                King of Diamonds
            </h1>
            <p class="text-xl text-gray-200">Real-time Multiplayer Strategy Game</p>
        </div>

        <div id="globalWinnerDisplay" class="winner-display-global">
            <h2 class="text-4xl font-bold text-yellow-400 mb-4">üèÜ Game Over! üèÜ</h2>
            <div id="globalWinnerContent" class="flex items-center justify-center space-x-4">
                </div>
            <p class="text-2xl text-gray-300 mt-2">Is the King of Diamonds!</p>
            <button id="globalNewGameBtn" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                <i class="fas fa-redo mr-2"></i>New Game
            </button>
        </div>

        <div id="mainMenu" class="max-w-md mx-auto">
            <div class="bg-gray-800 rounded-xl p-8 card-shadow slide-in text-gray-100">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-100">Join the Game</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Your Username</label>
                        <input type="text" id="usernameInput" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-700 text-gray-100" placeholder="Enter your username" maxlength="15">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Choose Avatar</label>
                        <div class="grid grid-cols-4 gap-2" id="avatarSelection">
                            <div class="avatar-option w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-blue-700 transition-colors text-2xl" data-avatar="üëë">üëë</div>
                            <div class="avatar-option w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-green-700 transition-colors text-2xl" data-avatar="üéØ">üéØ</div>
                            <div class="avatar-option w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-purple-700 transition-colors text-2xl" data-avatar="üöÄ">üöÄ</div>
                            <div class="avatar-option w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-red-700 transition-colors text-2xl" data-avatar="‚ö°">‚ö°</div>
                            <div class="avatar-option w-12 h-12 bg-yellow-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-yellow-700 transition-colors text-2xl" data-avatar="üåü">üåü</div>
                            <div class="avatar-option w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-indigo-700 transition-colors text-2xl" data-avatar="üé™">üé™</div>
                            <div class="avatar-option w-12 h-12 bg-pink-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-pink-700 transition-colors text-2xl" data-avatar="üé≠">üé≠</div>
                            <div class="avatar-option w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-gray-700 transition-colors text-2xl" data-avatar="üé®">üé®</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="createRoomBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            <i class="fas fa-plus mr-2"></i>Create Room
                        </button>
                        <button id="joinRoomBtn" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                            <i class="fas fa-sign-in-alt mr-2"></i>Join Room
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="joinRoomModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 bounce-in text-gray-100">
                <h3 class="text-xl font-bold mb-4 text-gray-100">Enter Room Code</h3>
                <input type="text" id="roomCodeInput" class="w-full p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent mb-4 bg-gray-700 text-gray-100" placeholder="Enter 6-digit room code" maxlength="6">
                <div class="flex space-x-4">
                    <button id="joinRoomConfirm" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">Join</button>
                    <button id="joinRoomCancel" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
                </div>
            </div>
        </div>

        <div id="gameRulesModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-8 max-w-2xl w-full mx-4 bounce-in text-gray-100">
                <h3 class="text-2xl font-bold mb-4 text-gray-100 text-center">How to Play King of Diamonds</h3>
                <div class="prose max-w-none text-gray-300 mb-6">
                    <p>Welcome to King of Diamonds! This is a real-time multiplayer strategy game where players try to guess a number closest to 80% of the average of all submitted numbers.</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Objective:</strong> Be the last player standing.</li>
                        <li><strong>Rounds:</strong> Each round has a time limit.</li>
                        <li><strong>Submission:</strong> During a round, each player chooses a number between 0 and 100 using the slider and clicks "Submit". You can only submit once per round.</li>
                        <li><strong>Calculating Results:</strong>
                            <ul class="list-circle list-inside ml-4">
                                <li>The game calculates the average of all submitted numbers from *active* players.</li>
                                <li>The "target" number is 80% of this average.</li>
                                <li>The player whose submitted number is closest to the target number wins the round.</li>
                            </ul>
                        </li>
                        <li><strong>Scoring:</strong>
                            <ul class="list-circle list-inside ml-4">
                                <li>The round winner gains 1 point.</li>
                                <li>All other active players lose 1 point.</li>
                                <li><strong>Tie Breaker:</strong> If two or more players choose the exact same number, they will each lose 2 points for that round, regardless of whether their number was closest to the target. This penalty applies in addition to any other score changes.</li>
                            </ul>
                        </li>
                        <li><strong>Special Rule (2 Players Left):</strong> If only two active players remain in the game, and one chooses 0 while the other chooses any number greater than 0, the player who chose 0 is automatically eliminated, and the other player wins the game.</li>
                        <li><strong>Elimination:</strong> If a player's score drops to or below the "Elimination Threshold" (default -5), they are eliminated from the game. Eliminated players cannot participate in subsequent rounds.</li>
                        <li><strong>Winning the Game:</strong> The game ends when only one player remains. That player is crowned the "King of Diamonds"!</li>
                    </ul>
                    <p class="mt-4 text-center font-semibold">Good luck, and may the smartest player win!</p>
                </div>
                <div class="flex justify-center">
                    <button id="rulesGotItBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        Got It! <i class="fas fa-check ml-2"></i>
                    </button>
                    <button id="rulesStartGameBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold ml-4 hidden">
                        <i class="fas fa-play mr-2"></i>Start Game
                    </button>
                </div>
            </div>
        </div>

        <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-6 max-w-sm w-full mx-4 bounce-in text-center text-gray-100">
                <h3 id="customAlertTitle" class="text-xl font-bold mb-4 text-gray-100">Alert</h3>
                <p id="customAlertMessage" class="text-gray-300 mb-6"></p>
                <button id="customAlertCloseBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
            </div>
        </div>

        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-8 max-w-sm w-full mx-4 bounce-in text-gray-100">
                <h3 class="text-2xl font-bold mb-6 text-gray-100 text-center">Settings</h3>
                <div class="space-y-4">
                    <button id="showRulesBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                        <i class="fas fa-question-circle mr-2"></i>How to Play
                    </button>
                    <button id="toggleSoundBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                        <i class="fas fa-volume-up mr-2"></i>Toggle Sound: <span id="soundStatus">On</span>
                    </button>
                    <button id="leaveGameBtn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold">
                        <i class="fas fa-door-open mr-2"></i>Leave Game
                    </button>
                </div>
                <button id="settingsCloseBtn" class="mt-8 w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors font-semibold">
                    Close
                </button>
            </div>
        </div>

        <div id="lobby" class="hidden flex-grow">
            <div class="max-w-4xl mx-auto">
                <div class="bg-gray-800 rounded-xl p-6 card-shadow mb-6 text-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-100">Game Lobby</h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-300">
                                Room Code: <span id="displayRoomCode" class="font-bold text-lg text-blue-400"></span>
                            </div>
                            <button id="copyRoomCode" class="bg-blue-800 text-blue-200 px-3 py-1 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-300">Players (<span id="playerCount">0</span>/5)</h3>
                            <div id="lobbyPlayersList" class="space-y-2"></div>
                        </div>
                        
                        <div id="adminControls" class="hidden">
                            <h3 class="text-lg font-semibold mb-3 text-gray-300">Admin Controls</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Elimination Threshold</label>
                                    <input type="number" id="eliminationThreshold" class="w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100" value="-5" min="-10" max="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Round Duration (seconds)</label>
                                    <input type="number" id="roundDuration" class="w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-100" value="180" min="30" max="600">
                                </div>
                                <button id="startGameBtn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                                    <i class="fas fa-play mr-2"></i>Start Game
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="gameArea" class="hidden flex-grow">
            <div class="max-w-6xl mx-auto">
                <div class="bg-gray-800 rounded-xl p-4 card-shadow mb-6 text-gray-100">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl font-bold text-gray-100">Round <span id="currentRound">1</span></div>
                            <div id="gameTimer" class="text-xl font-semibold text-blue-400"></div>
                        </div>
                        <div id="gameStatus" class="text-lg font-semibold text-green-400">Waiting for players...</div>
                    </div>
                </div>

                <div id="numberInputSection" class="bg-gray-800 rounded-xl p-6 card-shadow mb-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-100 text-center">Choose Your Number (0-100)</h3>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="numberSlider" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500" min="0" max="100" value="50">
                        <div id="numberDisplay" class="text-3xl font-bold text-blue-400 w-16 text-center">50</div>
                        <button id="submitNumberBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">Submit</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="playersGrid">
                    </div>

                <div id="resultsSection" class="bg-gray-800 rounded-xl p-6 card-shadow hidden text-gray-100">
                    <h3 class="text-xl font-bold mb-4 text-gray-100 text-center">Round Results</h3>
                    <div id="resultsContent"></div>
                </div>

                <div id="winnerSection" class="bg-gray-800 rounded-xl p-6 card-shadow hidden text-gray-100">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold text-yellow-400 mb-4">üèÜ Game Over! üèÜ</h2>
                        <div id="winnerContent"></div>
                        <button id="newGameBtn" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                            <i class="fas fa-redo mr-2"></i>New Game
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed top-4 right-4">
            <button id="settingsBtn" class="bg-white bg-opacity-10 text-white p-3 rounded-full hover:bg-opacity-20 transition-all">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration (REPLACE WITH YOUR OWN)
        // Use the global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Game State
        let gameState = {
            roomCode: '',
            playerId: '',
            playerName: '',
            playerAvatar: 'üëë', // Default avatar
            isHost: false,
            currentRoomRef: null, // Firebase reference to the current room
            gameData: null,
            isInGame: false,
            isSoundEnabled: true, // New setting for sound
            unsubscribeRoom: null, // To store the unsubscribe function for room data
            unsubscribePlayers: null // To store the unsubscribe function for player data
        };

        // Tone.js Sound Effects Setup
        let synthClick, synthSubmit, synthRoundStart, synthRoundEnd, synthEliminate, synthGameOver;

        // Function to initialize Tone.js synths
        function initAudio() {
            try {
                // Basic synth for clicks
                synthClick = new Tone.Synth().toDestination();
                synthClick.volume.value = -10; // Lower volume

                // Plucky sound for submission
                synthSubmit = new Tone.PluckSynth().toDestination();
                synthSubmit.volume.value = -8;

                // Warm pad for round start
                synthRoundStart = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.5, decay: 0.1, sustain: 0.2, release: 0.5 },
                    volume: -12
                }).toDestination();

                // FM synth for round end/results
                synthRoundEnd = new Tone.FMSynth({
                    harmonicity: 3.0,
                    modulationIndex: 10,
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.05, release: 0.5 },
                    modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.05, release: 0.5 },
                    volume: -10
                }).toDestination();

                // Noise for elimination
                synthEliminate = new Tone.NoiseSynth({
                    noise: { type: "pink" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 },
                    volume: -10
                }).toDestination();

                // Membrane synth for game over
                synthGameOver = new Tone.MembraneSynth().toDestination();
                synthGameOver.volume.value = -5;

                console.log("Tone.js audio context initialized.");
            } catch (e) {
                console.warn("Audio context not initialized:", e);
                // Fallback or disable sound if audio context fails
                gameState.isSoundEnabled = false; // Disable sound if init fails
                document.getElementById('soundStatus').textContent = 'Off';
            }
        }

        // Helper function to play sounds
        function playSound(type) {
            if (!gameState.isSoundEnabled) return; // Check if sound is enabled

            if (!Tone.context || Tone.context.state !== 'running') {
                // Attempt to resume audio context on first user interaction
                Tone.start().then(() => {
                    console.log("Audio context resumed.");
                    _actuallyPlaySound(type);
                }).catch(e => console.error("Failed to resume audio context:", e));
            } else {
                _actuallyPlaySound(type);
            }
        }

        function _actuallyPlaySound(type) {
            switch (type) {
                case 'click':
                    synthClick.triggerAttackRelease("C4", "8n");
                    break;
                case 'submit':
                    synthSubmit.triggerAttackRelease("G4", "8n");
                    break;
                case 'roundStart':
                    synthRoundStart.triggerAttackRelease(["C4", "E4", "G4"], "1n");
                    break;
                case 'roundEnd':
                    synthRoundEnd.triggerAttackRelease("C3", "4n");
                    break;
                case 'eliminate':
                    synthEliminate.triggerAttackRelease("8n");
                    break;
                case 'gameOver':
                    synthGameOver.triggerAttackRelease("C2", "2n");
                    break;
                default:
                    break;
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initAudio(); // Initialize audio context on DOM load
            initializeApp();
        });

        async function initializeApp() {
            // Authenticate anonymously or with custom token
            if (typeof __initial_auth_token !== 'undefined') {
                try {
                    await auth.signInWithCustomToken(__initial_auth_token);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    await auth.signInAnonymously();
                    console.log("Signed in anonymously as fallback.");
                }
            } else {
                await auth.signInAnonymously();
                console.log("Signed in anonymously.");
            }

            // Set player ID after authentication
            gameState.playerId = auth.currentUser.uid;
            document.getElementById('myPlayerIdDisplay').textContent = gameState.playerId;

            setupEventListeners();
            showMainMenu();
        }

        function setupEventListeners() {
            // Avatar selection
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    playSound('click');
                    document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('ring-4', 'ring-blue-400'));
                    this.classList.add('ring-4', 'ring-blue-400');
                    gameState.playerAvatar = this.dataset.avatar;
                });
            });

            // Main menu buttons
            document.getElementById('createRoomBtn').addEventListener('click', function() { playSound('click'); createRoom(); });
            document.getElementById('joinRoomBtn').addEventListener('click', function() { playSound('click'); showJoinRoomModal(); });
            document.getElementById('joinRoomConfirm').addEventListener('click', function() { playSound('click'); joinRoom(); });
            document.getElementById('joinRoomCancel').addEventListener('click', function() { playSound('click'); hideJoinRoomModal(); });

            // Game rules modal buttons
            document.getElementById('rulesGotItBtn').addEventListener('click', function() { playSound('click'); hideGameRulesModal(); });
            document.getElementById('rulesStartGameBtn').addEventListener('click', function() { playSound('click'); startGame(); hideGameRulesModal(); });

            // Game controls
            document.getElementById('startGameBtn').addEventListener('click', function() { playSound('click'); startGame(); });
            document.getElementById('submitNumberBtn').addEventListener('click', function() { playSound('submit'); submitNumber(); });
            document.getElementById('newGameBtn').addEventListener('click', function() { playSound('click'); returnToLobby(); });
            document.getElementById('globalNewGameBtn').addEventListener('click', function() { playSound('click'); returnToLobby(); });


            // Room code copy
            document.getElementById('copyRoomCode').addEventListener('click', function() { playSound('click'); copyRoomCode(); });

            // Number slider
            document.getElementById('numberSlider').addEventListener('input', function() {
                document.getElementById('numberDisplay').textContent = this.value;
            });

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', function() { playSound('click'); showSettingsModal(); });
            document.getElementById('settingsCloseBtn').addEventListener('click', function() { playSound('click'); hideSettingsModal(); });
            document.getElementById('showRulesBtn').addEventListener('click', function() { playSound('click'); showGameRulesModal(false); hideSettingsModal(); });
            document.getElementById('toggleSoundBtn').addEventListener('click', function() {
                gameState.isSoundEnabled = !gameState.isSoundEnabled;
                document.getElementById('soundStatus').textContent = gameState.isSoundEnabled ? 'On' : 'Off';
                playSound('click'); // Play click sound if just turned on
            });
            document.getElementById('leaveGameBtn').addEventListener('click', function() { playSound('click'); leaveGame(); });


            // Custom Alert Close Button
            document.getElementById('customAlertCloseBtn').addEventListener('click', function() { playSound('click'); hideCustomAlert(); });
        }

        // Custom Alert Functions
        function showAlert(message, title = 'Alert') {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('customAlertModal').classList.remove('hidden');
        }

        function hideCustomAlert() {
            document.getElementById('customAlertModal').classList.add('hidden');
        }

        // Settings Modal Functions
        function showSettingsModal() {
            document.getElementById('soundStatus').textContent = gameState.isSoundEnabled ? 'On' : 'Off';
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function leaveGame() {
            if (gameState.currentRoomRef) {
                // Remove player from the room
                gameState.currentRoomRef.child('players/' + gameState.playerId).remove()
                    .then(() => {
                        console.log("Player removed from room.");
                        cleanupGameListeners();
                        showMainMenu();
                        showAlert('You have left the game.', 'Left Game');
                    })
                    .catch(error => {
                        console.error("Error leaving game:", error);
                        showAlert('Failed to leave game. Please try again.', 'Error');
                    });
            } else {
                showMainMenu();
            }
            hideSettingsModal();
        }


        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameRulesModal').classList.add('hidden'); // Ensure rules are hidden
            document.getElementById('leftDashboard').classList.add('hidden'); // Hide dashboard
            document.getElementById('globalWinnerDisplay').style.display = 'none'; // Explicitly hide global winner display
            gameState.isInGame = false;
            cleanupGameListeners(); // Clean up listeners when returning to main menu
        }

        function showJoinRoomModal() {
            if (!validateInput()) return;
            document.getElementById('joinRoomModal').classList.remove('hidden');
        }

        function hideJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.add('hidden');
            document.getElementById('roomCodeInput').value = '';
        }

        function validateInput() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                showAlert('Please enter a username');
                return false;
            }
            if (!gameState.playerAvatar || gameState.playerAvatar === ' ') {
                showAlert('Please select an avatar');
                return false;
            }
            gameState.playerName = username;
            return true;
        }

        function createRoom() {
            if (!validateInput()) return;
            
            const roomCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            gameState.roomCode = roomCode;
            gameState.isHost = true;

            const roomData = {
                code: roomCode,
                host: gameState.playerId,
                players: {
                    [gameState.playerId]: {
                        name: gameState.playerName,
                        avatar: gameState.playerAvatar,
                        score: 0,
                        submittedNumber: null,
                        eliminated: false,
                        isHost: true
                    }
                },
                settings: {
                    eliminationThreshold: -5,
                    roundDuration: 180,
                    maxPlayers: 5
                },
                gameStatus: 'lobby',
                currentRound: 0,
                roundStartTime: null,
                submissions: {},
                results: {},
                winner: null
            };

            database.ref(`artifacts/${appId}/public/data/rooms/${roomCode}`).set(roomData)
                .then(() => {
                    joinRoomSuccess(roomCode);
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                    showAlert('Failed to create room. Please try again.', 'Error');
                });
        }

        function joinRoom() {
            if (!validateInput()) return;
            
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                showAlert('Please enter a valid 6-digit room code');
                return;
            }

            database.ref(`artifacts/${appId}/public/data/rooms/${roomCode}`).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showAlert('Room does not exist. Please check the code.', 'Room Not Found');
                        hideJoinRoomModal();
                        return;
                    }

                    const roomData = snapshot.val();
                    const players = roomData.players || {};
                    const playerCount = Object.keys(players).length;

                    if (playerCount >= roomData.settings.maxPlayers) {
                        showAlert('Room is full. Please try another room.', 'Room Full');
                        hideJoinRoomModal();
                        return;
                    }

                    if (players[gameState.playerId]) {
                        // Player already in this room, just re-join
                        showAlert('You are already in this room.', 'Already Joined');
                        gameState.roomCode = roomCode;
                        gameState.isHost = (roomData.host === gameState.playerId);
                        joinRoomSuccess(roomCode);
                        return;
                    }

                    // Calculate average score for mid-game join
                    let initialScore = 0;
                    if (roomData.gameStatus !== 'lobby' && Object.keys(players).length > 0) {
                        const activePlayers = Object.values(players).filter(p => !p.eliminated);
                        if (activePlayers.length > 0) {
                            const totalScore = activePlayers.reduce((sum, p) => sum + p.score, 0);
                            initialScore = Math.round(totalScore / activePlayers.length);
                            showAlert(`Joining mid-game! Your starting score is ${initialScore}.`, 'Mid-Game Join');
                        }
                    }

                    const newPlayer = {
                        name: gameState.playerName,
                        avatar: gameState.playerAvatar,
                        score: initialScore,
                        submittedNumber: null,
                        eliminated: false,
                        isHost: false
                    };

                    database.ref(`artifacts/${appId}/public/data/rooms/${roomCode}/players/${gameState.playerId}`).set(newPlayer)
                        .then(() => {
                            gameState.roomCode = roomCode;
                            gameState.isHost = (roomData.host === gameState.playerId); // Re-check host status
                            joinRoomSuccess(roomCode);
                        })
                        .catch(error => {
                            console.error('Error joining room:', error);
                            showAlert('Failed to join room. Please try again.', 'Error');
                        });
                })
                .catch(error => {
                    console.error('Error checking room:', error);
                    showAlert('Failed to join room. Please check your internet connection.', 'Error');
                });
            hideJoinRoomModal();
        }

        function joinRoomSuccess(roomCode) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('leftDashboard').classList.remove('hidden'); // Show dashboard
            gameState.isInGame = true;

            document.getElementById('displayRoomCode').textContent = roomCode;
            gameState.currentRoomRef = database.ref(`artifacts/${appId}/public/data/rooms/${roomCode}`);

            // Listen for changes in the room data
            gameState.unsubscribeRoom = gameState.currentRoomRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    gameState.gameData = data;
                    updateLobbyUI();
                    if (data.gameStatus === 'playing' || data.gameStatus === 'results' || data.gameStatus === 'gameOver') {
                        updateGameUI();
                    }
                } else {
                    // Room was deleted or no data
                    showAlert('The room you were in no longer exists.', 'Room Closed');
                    showMainMenu();
                }
            }, error => {
                console.error("Error listening to room data:", error);
                showAlert('Lost connection to the room. Returning to main menu.', 'Connection Error');
                showMainMenu();
            });
        }

        function cleanupGameListeners() {
            if (gameState.unsubscribeRoom) {
                gameState.currentRoomRef.off('value', gameState.unsubscribeRoom);
                gameState.unsubscribeRoom = null;
            }
            // Clear any interval timers
            if (window.gameTimerInterval) {
                clearInterval(window.gameTimerInterval);
                window.gameTimerInterval = null;
            }
        }

        function updateLobbyUI() {
            const data = gameState.gameData;
            if (!data) return;

            const players = data.players || {};
            const playerCount = Object.keys(players).length;
            document.getElementById('playerCount').textContent = playerCount;

            const lobbyPlayersList = document.getElementById('lobbyPlayersList');
            lobbyPlayersList.innerHTML = ''; // Clear existing list

            Object.keys(players).forEach(playerId => {
                const player = players[playerId];
                const playerCard = document.createElement('div');
                playerCard.className = `player-card flex items-center justify-between p-3 rounded-lg shadow-md ${player.eliminated ? 'elimination-effect' : ''}`;
                playerCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-500 text-white text-xl font-bold">
                            ${player.avatar}
                        </div>
                        <div>
                            <span class="font-semibold text-gray-100">${player.name}</span>
                            ${player.isHost ? '<i class="fas fa-crown text-yellow-400 ml-1"></i>' : ''}
                            ${playerId === gameState.playerId ? '<span class="text-xs text-gray-400">(You)</span>' : ''}
                        </div>
                    </div>
                    ${gameState.isHost && playerId !== gameState.playerId ? `
                        <button class="remove-player-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors text-sm" data-player-id="${playerId}">Remove</button>
                    ` : ''}
                `;
                lobbyPlayersList.appendChild(playerCard);
            });

            // Add event listeners for remove player buttons
            lobbyPlayersList.querySelectorAll('.remove-player-btn').forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                    const playerIdToRemove = this.dataset.playerId;
                    removePlayer(playerIdToRemove);
                });
            });


            // Admin controls visibility
            if (gameState.isHost) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('eliminationThreshold').value = data.settings.eliminationThreshold;
                document.getElementById('roundDuration').value = data.settings.roundDuration;

                // Update settings in Firebase if changed by host
                document.getElementById('eliminationThreshold').onchange = (e) => {
                    const newValue = parseInt(e.target.value);
                    if (!isNaN(newValue)) {
                        gameState.currentRoomRef.child('settings/eliminationThreshold').set(newValue);
                    }
                };
                document.getElementById('roundDuration').onchange = (e) => {
                    const newValue = parseInt(e.target.value);
                    if (!isNaN(newValue)) {
                        gameState.currentRoomRef.child('settings/roundDuration').set(newValue);
                    }
                };
            } else {
                document.getElementById('adminControls').classList.add('hidden');
            }

            // Show rules button for host in lobby only if game hasn't started
            const rulesStartGameBtn = document.getElementById('rulesStartGameBtn');
            if (gameState.isHost && data.gameStatus === 'lobby') {
                rulesStartGameBtn.classList.remove('hidden');
            } else {
                rulesStartGameBtn.classList.add('hidden');
            }
        }

        function removePlayer(playerIdToRemove) {
            if (!gameState.isHost || !gameState.gameData) {
                showAlert('You do not have permission to remove players.', 'Permission Denied');
                return;
            }

            if (playerIdToRemove === gameState.playerId) {
                showAlert('You cannot remove yourself.', 'Error');
                return;
            }

            if (!confirm(`Are you sure you want to remove this player?`)) {
                return;
            }

            const updates = {};
            updates[`players/${playerIdToRemove}/eliminated`] = true;
            updates[`players/${playerIdToRemove}/score`] = gameState.gameData.settings.eliminationThreshold - 10; // Ensure they are far below threshold

            gameState.currentRoomRef.update(updates)
                .then(() => {
                    console.log(`Player ${playerIdToRemove} removed.`);
                    showAlert('Player has been removed.', 'Player Removed');
                })
                .catch(error => {
                    console.error("Error removing player:", error);
                    showAlert('Failed to remove player. Please try again.', 'Error');
                });
        }

        function showGameRulesModal(showStartGameButton = true) {
            if (showStartGameButton && gameState.isHost && gameState.gameData.gameStatus === 'lobby') {
                document.getElementById('rulesStartGameBtn').classList.remove('hidden');
            } else {
                document.getElementById('rulesStartGameBtn').classList.add('hidden');
            }
            document.getElementById('gameRulesModal').classList.remove('hidden');
        }

        function hideGameRulesModal() {
            document.getElementById('gameRulesModal').classList.add('hidden');
        }


        function startGame() {
            if (!gameState.isHost) {
                showAlert('Only the host can start the game.', 'Permission Denied');
                return;
            }
            if (!gameState.gameData || Object.keys(gameState.gameData.players).length < 2) {
                showAlert('You need at least 2 players to start the game.', 'Not Enough Players');
                return;
            }

            playSound('roundStart'); // Play sound for game start

            gameState.currentRoomRef.update({
                gameStatus: 'playing',
                currentRound: 1,
                roundStartTime: firebase.database.ServerValue.TIMESTAMP,
                submissions: {},
                results: {},
                winner: null
            })
            .then(() => {
                console.log('Game started!');
            })
            .catch(error => {
                console.error('Error starting game:', error);
                showAlert('Failed to start game. Please try again.', 'Error');
            });
        }

        function updateGameUI() {
            const data = gameState.gameData;
            if (!data) return;

            // Hide lobby, show game area
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            document.getElementById('leftDashboard').classList.remove('hidden'); // Ensure dashboard is visible

            document.getElementById('currentRound').textContent = data.currentRound;
            document.getElementById('gameStatus').textContent = `Round in progress...`;

            updatePlayerCards();

            // Handle game states
            if (data.gameStatus === 'playing') {
                document.getElementById('numberInputSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('winnerSection').classList.add('hidden');
                document.getElementById('globalWinnerDisplay').style.display = 'none'; // Ensure global winner is hidden

                // Enable submit button if not submitted yet
                const myPlayer = data.players[gameState.playerId];
                if (myPlayer && !myPlayer.eliminated && myPlayer.submittedNumber === null) {
                    document.getElementById('submitNumberBtn').disabled = false;
                } else {
                    document.getElementById('submitNumberBtn').disabled = true; // Disable if submitted or eliminated
                }

                startRoundTimer(data.roundStartTime, data.settings.roundDuration);

            } else if (data.gameStatus === 'results') {
                document.getElementById('numberInputSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('winnerSection').classList.add('hidden');
                document.getElementById('globalWinnerDisplay').style.display = 'none'; // Ensure global winner is hidden
                displayResults(data.results);
                // Clear timer when in results phase
                if (window.gameTimerInterval) {
                    clearInterval(window.gameTimerInterval);
                    window.gameTimerInterval = null;
                }
                // Transition to next round or game over after a delay
                if (gameState.isHost) {
                    setTimeout(() => {
                        const activePlayersCount = Object.values(data.players).filter(p => !p.eliminated).length;
                        if (activePlayersCount <= 1) {
                            endGame();
                        } else {
                            startNextRound();
                        }
                    }, 5000); // Display results for 5 seconds
                }

            } else if (data.gameStatus === 'gameOver') {
                document.getElementById('numberInputSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('winnerSection').classList.remove('hidden'); // Show game over section
                document.getElementById('globalWinnerDisplay').style.display = 'flex'; // Show global winner overlay
                displayGameOver(data.winner, data.players);
                // Clear timer when game is over
                if (window.gameTimerInterval) {
                    clearInterval(window.gameTimerInterval);
                    window.gameTimerInterval = null;
                }
            }
        }

        function startRoundTimer(startTime, duration) {
            if (window.gameTimerInterval) {
                clearInterval(window.gameTimerInterval);
            }

            const timerElement = document.getElementById('gameTimer');
            const endTime = startTime + (duration * 1000); // Calculate end time in milliseconds

            window.gameTimerInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = Math.max(0, endTime - now); // Time left in milliseconds

                const seconds = Math.floor((timeLeft / 1000) % 60);
                const minutes = Math.floor((timeLeft / 1000) / 60);

                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(window.gameTimerInterval);
                    timerElement.textContent = '00:00';
                    if (gameState.isHost && gameState.gameData.gameStatus === 'playing') {
                        calculateResults();
                    }
                }
            }, 1000);
        }


        function submitNumber() {
            const number = parseInt(document.getElementById('numberSlider').value);
            const myPlayer = gameState.gameData.players[gameState.playerId];

            if (!myPlayer || myPlayer.eliminated) {
                showAlert('You are eliminated and cannot submit.', 'Eliminated');
                return;
            }

            if (myPlayer.submittedNumber !== null) {
                showAlert('You have already submitted a number for this round.', 'Already Submitted');
                return;
            }

            gameState.currentRoomRef.child(`players/${gameState.playerId}/submittedNumber`).set(number)
                .then(() => {
                    document.getElementById('submitNumberBtn').disabled = true; // Disable button after submission
                    console.log(`Player ${gameState.playerName} submitted ${number}`);
                })
                .catch(error => {
                    console.error('Error submitting number:', error);
                    showAlert('Failed to submit number. Please try again.', 'Error');
                });
        }

        function calculateResults() {
            const gameData = gameState.gameData;
            if (!gameData || gameData.gameStatus !== 'playing') return;

            const players = gameData.players;
            const submissions = {};
            const activePlayers = [];

            // Collect active player submissions and identify ties
            const submittedNumbersCount = {}; // To count occurrences of each submitted number
            Object.keys(players).forEach(id => {
                const player = players[id];
                if (!player.eliminated && player.submittedNumber !== null) {
                    activePlayers.push({ id: id, ...player });
                    submissions[id] = player.submittedNumber;
                    submittedNumbersCount[player.submittedNumber] = (submittedNumbersCount[player.submittedNumber] || 0) + 1;
                }
            });

            if (activePlayers.length === 0) {
                // If no active players submitted, just end the round without score changes
                gameState.currentRoomRef.update({
                    gameStatus: 'results',
                    results: {
                        message: "No active players submitted numbers this round. No score changes."
                    },
                    roundStartTime: null // Reset timer
                });
                return;
            }

            // --- New Rule: 2 Players Left & One Chooses 0 ---
            if (activePlayers.length === 2) {
                const player1 = activePlayers[0];
                const player2 = activePlayers[1];

                const sub1 = submissions[player1.id];
                const sub2 = submissions[player2.id];

                if ((sub1 === 0 && sub2 !== 0) || (sub2 === 0 && sub1 !== 0)) {
                    const loserId = sub1 === 0 ? player1.id : player2.id;
                    const winnerId = sub1 === 0 ? player2.id : player1.id;

                    const updates = {};
                    updates[`players/${loserId}/eliminated`] = true;
                    updates[`players/${loserId}/score`] = gameData.settings.eliminationThreshold - 10; // Ensure eliminated
                    updates[`winner`] = winnerId; // Set winner immediately
                    updates[`gameStatus`] = 'gameOver';

                    gameState.currentRoomRef.update(updates);
                    playSound('gameOver');
                    return; // Game over, no need to proceed with normal calculation
                }
            }
            // --- End New Rule ---


            const sum = activePlayers.reduce((total, p) => total + p.submittedNumber, 0);
            const average = sum / activePlayers.length;
            const target = 0.8 * average;

            let winnerId = null;
            let minDifference = Infinity;
            let potentialWinners = [];

            // Determine initial potential winners based on closest to target
            activePlayers.forEach(p => {
                const diff = Math.abs(p.submittedNumber - target);
                if (diff < minDifference) {
                    minDifference = diff;
                    potentialWinners = [p.id];
                } else if (diff === minDifference) {
                    potentialWinners.push(p.id);
                }
            });

            // If there's a tie for closest, choose the smallest number
            if (potentialWinners.length > 1) {
                let smallestNumber = Infinity;
                let finalWinnerCandidates = [];
                potentialWinners.forEach(id => {
                    const num = submissions[id];
                    if (num < smallestNumber) {
                        smallestNumber = num;
                        finalWinnerCandidates = [id];
                    } else if (num === smallestNumber) {
                        finalWinnerCandidates.push(id);
                    }
                });
                // If still tied (e.g., multiple players picked same smallest number closest to target), first one in list (arbitrary)
                winnerId = finalWinnerCandidates[0];
            } else {
                winnerId = potentialWinners[0];
            }


            const newPlayerScores = { ...players }; // Copy current scores

            const roundResults = {
                average: parseFloat(average.toFixed(2)),
                target: parseFloat(target.toFixed(2)),
                submissions: {},
                winner: winnerId,
                scoreChanges: {},
                eliminatedPlayers: []
            };

            // Apply score changes
            Object.keys(players).forEach(id => {
                const player = players[id];
                roundResults.submissions[id] = player.submittedNumber !== null ? player.submittedNumber : 'N/A'; // Record all submissions

                if (!player.eliminated) { // Only change scores for active players
                    let scoreChange = 0;
                    if (id === winnerId) {
                        scoreChange = 1; // Winner gains 1 point
                    } else if (player.submittedNumber !== null) {
                        scoreChange = -1; // Others lose 1 point if they submitted
                    }
                    newPlayerScores[id].score += scoreChange;
                    roundResults.scoreChanges[id] = scoreChange; // Record the base score change
                }
            });

            // --- New Rule: Tie Breaker Penalty ---
            Object.keys(submissions).forEach(submitterId => {
                const submittedVal = submissions[submitterId];
                if (submittedNumbersCount[submittedVal] > 1) {
                    // This player participated in a tie
                    if (!newPlayerScores[submitterId].eliminated) { // Only penalize if not already eliminated
                        newPlayerScores[submitterId].score -= 2; // Deduct 2 points for tying
                        roundResults.scoreChanges[submitterId] = (roundResults.scoreChanges[submitterId] || 0) - 2; // Update recorded change
                    }
                }
            });
            // --- End New Rule ---

            // Check for eliminations and update player status
            Object.keys(newPlayerScores).forEach(id => {
                const player = newPlayerScores[id];
                if (!player.eliminated && player.score <= gameData.settings.eliminationThreshold) {
                    player.eliminated = true;
                    roundResults.eliminatedPlayers.push(id);
                    playSound('eliminate');
                }
            });

            // Update Firebase
            const updates = {
                gameStatus: 'results',
                results: roundResults,
                roundStartTime: null, // Reset timer
                submissions: {} // Clear submissions for next round
            };

            Object.keys(newPlayerScores).forEach(id => {
                updates[`players/${id}/score`] = newPlayerScores[id].score;
                updates[`players/${id}/eliminated`] = newPlayerScores[id].eliminated;
                updates[`players/${id}/submittedNumber`] = null; // Reset for next round
            });

            gameState.currentRoomRef.update(updates)
                .then(() => {
                    playSound('roundEnd');
                    console.log('Results calculated and updated.');
                })
                .catch(error => {
                    console.error('Error updating results:', error);
                    showAlert('Failed to update results. Please check your connection.', 'Error');
                });
        }

        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = ''; // Clear previous results

            if (results.message) {
                resultsContent.innerHTML = `<p class="text-center text-xl text-yellow-300 font-semibold">${results.message}</p>`;
                return;
            }

            const winner = gameState.gameData.players[results.winner];
            let winnerHtml = '';
            if (winner) {
                 winnerHtml = `
                    <div class="flex items-center justify-center space-x-3 bg-gray-700 p-3 rounded-lg shadow-inner mb-4 bounce-in">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center bg-yellow-500 text-white text-3xl font-bold">
                            ${winner.avatar}
                        </div>
                        <span class="text-2xl font-bold text-yellow-300">${winner.name}</span>
                        <span class="text-xl text-yellow-200">wins the round!</span>
                    </div>
                `;
            } else {
                 winnerHtml = `<p class="text-center text-xl text-gray-300">No clear winner this round.</p>`;
            }

            let playerResultsHtml = `
                <div class="text-center text-lg text-gray-200 mb-4">
                    Average: <span class="font-bold text-blue-300">${results.average}</span> |
                    Target (80% Avg): <span class="font-bold text-green-300">${results.target}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            Object.keys(results.submissions).forEach(playerId => {
                const player = gameState.gameData.players[playerId];
                if (!player) return; // Player might have left

                const submitted = results.submissions[playerId];
                const scoreChange = results.scoreChanges[playerId] || 0;
                const scoreChangeClass = scoreChange > 0 ? 'text-green-400' : (scoreChange < 0 ? 'text-red-400' : 'text-gray-400');
                const scoreChangeSign = scoreChange > 0 ? '+' : '';

                playerResultsHtml += `
                    <div class="bg-gray-700 p-3 rounded-lg shadow-md flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center bg-indigo-500 text-white text-xl">
                                ${player.avatar}
                            </div>
                            <span class="font-semibold text-gray-100">${player.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm text-gray-300">Submitted: <span class="font-bold text-blue-300">${submitted}</span></span>
                            <span class="block text-sm ${scoreChangeClass}">Score: ${scoreChangeSign}${scoreChange}</span>
                        </div>
                    </div>
                `;
            });
            playerResultsHtml += '</div>';

            resultsContent.innerHTML = winnerHtml + playerResultsHtml;

            if (results.winner === gameState.playerId) {
                createConfetti(); // Create confetti for winner
            }
        }


        function startNextRound() {
            if (!gameState.isHost) return;

            const nextRound = gameState.gameData.currentRound + 1;
            gameState.currentRoomRef.update({
                gameStatus: 'playing',
                currentRound: nextRound,
                roundStartTime: firebase.database.ServerValue.TIMESTAMP,
                submissions: {} // Ensure submissions are clear
            })
            .then(() => {
                playSound('roundStart');
                console.log(`Starting round ${nextRound}`);
            })
            .catch(error => {
                console.error('Error starting next round:', error);
                showAlert('Failed to start next round. Please try again.', 'Error');
            });
        }

        function endGame() {
            if (!gameState.isHost) return;

            const activePlayers = Object.values(gameState.gameData.players).filter(p => !p.eliminated);
            let finalWinnerId = null;

            if (activePlayers.length === 1) {
                finalWinnerId = activePlayers[0].id;
            } else if (activePlayers.length === 0) {
                // All eliminated, no winner
                finalWinnerId = 'no-winner';
            } else {
                // Should not happen if game loop is correct, but as a fallback
                // find player with highest score among active players
                let maxScore = -Infinity;
                activePlayers.forEach(p => {
                    if (p.score > maxScore) {
                        maxScore = p.score;
                        finalWinnerId = p.id;
                    }
                });
            }

            gameState.currentRoomRef.update({
                gameStatus: 'gameOver',
                winner: finalWinnerId,
                roundStartTime: null // Clear timer
            })
            .then(() => {
                playSound('gameOver');
                console.log('Game Over!');
            })
            .catch(error => {
                console.error('Error ending game:', error);
                showAlert('Failed to end game. Please try again.', 'Error');
            });
        }

        function displayGameOver(winnerId, playersData) {
            const winnerContent = document.getElementById('winnerContent');
            const globalWinnerContent = document.getElementById('globalWinnerContent');
            winnerContent.innerHTML = '';
            globalWinnerContent.innerHTML = '';

            let winnerName = 'No Winner';
            let winnerAvatar = '‚ùì';

            if (winnerId && winnerId !== 'no-winner' && playersData[winnerId]) {
                const winner = playersData[winnerId];
                winnerName = winner.name;
                winnerAvatar = winner.avatar;
                createConfetti(); // Confetti for the ultimate winner
            }

            const winnerHtml = `
                <div class="flex items-center justify-center space-x-4 bg-gray-700 p-4 rounded-lg shadow-inner bounce-in">
                    <div class="w-16 h-16 rounded-full flex items-center justify-center bg-yellow-500 text-white text-4xl font-bold">
                        ${winnerAvatar}
                    </div>
                    <span class="text-3xl font-bold text-yellow-300">${winnerName}</span>
                </div>
            `;
            winnerContent.innerHTML = winnerHtml;
            globalWinnerContent.innerHTML = winnerHtml;
        }


        function updatePlayerCards() {
            const playersGrid = document.getElementById('playersGrid');
            const dashboardPlayersList = document.getElementById('dashboardPlayersList');
            playersGrid.innerHTML = '';
            dashboardPlayersList.innerHTML = '';

            const players = gameState.gameData.players || {};

            Object.keys(players).forEach(id => {
                const player = players[id];
                const isMe = id === gameState.playerId;

                // Player card for main game area
                const playerCard = document.createElement('div');
                playerCard.className = `player-card p-4 rounded-lg shadow-lg flex flex-col items-center relative ${player.eliminated ? 'elimination-animation' : ''} ${isMe ? 'border-4 border-blue-500' : ''}`;
                playerCard.innerHTML = `
                    <div class="w-16 h-16 rounded-full flex items-center justify-center bg-opacity-80 text-white text-4xl font-bold mb-2 ${player.eliminated ? 'bg-gray-500' : 'bg-blue-600'}">
                        ${player.avatar}
                    </div>
                    <span class="font-semibold text-xl text-gray-100 mb-1">${player.name} ${isMe ? '(You)' : ''}</span>
                    <span class="text-3xl font-bold ${player.score <= gameState.gameData.settings.eliminationThreshold ? 'text-red-500' : 'text-green-500'}">${player.score}</span>
                    ${player.eliminated ? '<span class="text-red-400 font-bold mt-2">ELIMINATED</span>' : ''}
                    ${player.submittedNumber !== null ? '<span class="text-blue-300 text-sm mt-1">Submitted: ' + player.submittedNumber + '</span>' : ''}
                    ${gameState.isHost && !isMe ? `
                        <button class="remove-player-btn absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors text-xs" data-player-id="${id}" title="Remove Player">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                `;
                playersGrid.appendChild(playerCard);

                // Dashboard player card
                const dashboardPlayerCard = document.createElement('div');
                dashboardPlayerCard.className = `dashboard-player-card flex items-center justify-between p-3 rounded-lg shadow-md ${player.eliminated ? 'eliminated' : ''} ${isMe ? 'border-2 border-blue-500' : ''}`;
                dashboardPlayerCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-500 text-white text-xl font-bold">
                            ${player.avatar}
                        </div>
                        <div>
                            <span class="font-semibold text-gray-100">${player.name}</span>
                            ${player.isHost ? '<i class="fas fa-crown text-yellow-400 ml-1"></i>' : ''}
                            ${isMe ? '<span class="text-xs text-gray-400">(You)</span>' : ''}
                        </div>
                    </div>
                    <span class="font-bold text-lg ${player.score <= gameState.gameData.settings.eliminationThreshold ? 'text-red-400' : 'text-green-400'}">${player.score}</span>
                `;
                dashboardPlayersList.appendChild(dashboardPlayerCard);
            });

            // Re-attach event listeners for remove player buttons in game area
            playersGrid.querySelectorAll('.remove-player-btn').forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                    const playerIdToRemove = this.dataset.playerId;
                    removePlayer(playerIdToRemove);
                });
            });
        }


        function returnToLobby() {
            if (!gameState.isHost) {
                showAlert('Only the host can reset the game to lobby.', 'Permission Denied');
                return;
            }

            // Reset scores and eliminated status for all players in Firebase
            const playersUpdate = {};
            Object.keys(gameState.gameData.players).forEach(playerId => {
                playersUpdate[`players/${playerId}/score`] = 0;
                playersUpdate[`players/${playerId}/eliminated`] = false;
                playersUpdate[`players/${playerId}/submittedNumber`] = null;
            });

            gameState.currentRoomRef.update({
                gameStatus: 'lobby',
                currentRound: 0,
                roundStartTime: null,
                submissions: {},
                results: {},
                winner: null,
                ...playersUpdate // Apply player resets
            })
            .then(() => {
                console.log('Game reset to lobby.');
                // UI will update via listener
            })
            .catch(error => {
                console.error('Error resetting game:', error);
                showAlert('Failed to reset game. Please try again.', 'Error');
            });
            document.getElementById('globalWinnerDisplay').style.display = 'none'; // Hide global winner on new game
        }


        // Utility function to copy room code to clipboard
        function copyRoomCode() {
            const roomCode = document.getElementById('displayRoomCode').textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                showAlert('Room code copied to clipboard!', 'Copied!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showAlert('Failed to copy room code.', 'Error');
            });
        }

        // Confetti effect
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = Math.random() * -10 + 'vh';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`;
                confetti.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(confetti);

                // Remove confetti after animation to prevent DOM bloat
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }
    </script>
</body>
</html>
